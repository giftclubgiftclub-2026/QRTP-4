<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QRTP-4 — Generate Passport</title>
  <style>
    :root{--bg:#f5f7fb;--card:#fff;--line:#e6eaf2;--text:#0b1220;--muted:#5b667a;--blue:#2563eb;--ok:#059669}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:900px;margin:0 auto;padding:28px 18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:18px;margin-top:14px}
    .badge{font-size:12px;color:var(--muted)}
    h1{margin:8px 0 0;font-size:22px}
    .hint{color:var(--muted);font-size:13px;line-height:1.45;margin-top:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{border:0;border-radius:14px;padding:12px 16px;font-weight:900;background:var(--blue);color:#fff;cursor:pointer}
    .btn2{border:1px solid var(--line);background:#fff;color:var(--text)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:14px}
    .pill{display:inline-block;border-radius:999px;padding:8px 12px;font-weight:900;font-size:12px;background:#ecfdf5;color:var(--ok);border:1px solid #a7f3d0}
    a{color:var(--blue);text-decoration:none}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="badge">QRTP-4 Global Standard</div>
    <h1>Generate Passport (MVP)</h1>
    <div class="hint">
      This generator creates a new QRTP4_ID for the user.<br/>
      In MVP mode, the passport is generated locally and can be shared instantly.<br/>
      Next upgrade: automatic issuance + registry write (serverless).
    </div>

    <div class="row">
      <button id="gen">Generate QRTP4_ID</button>
      <button class="btn2" onclick="location.href='../'">Back to Portal</button>
    </div>
  </div>

  <div class="card" id="out" style="display:none">
    <div class="badge">Generated Passport</div>
    <div style="margin-top:10px">
      <span class="pill">READY</span>
    </div>

    <div style="margin-top:12px" class="mono">
      ID: <b id="pid"></b>
    </div>

    <div style="margin-top:10px" class="mono">
      Link: <span id="plink"></span>
    </div>

        <div style="margin-top:12px">
                <div class="badge">Delivery</div>
                <div class="hint" style="margin-top:8px">
                          Enter your email to issue the passport and receive the verification link.
                        </div>

                <div class="row" style="margin-top:10px">
                          <input id="email" type="email" placeholder="name@email.com"
                                      style="flex:1;min-width:220px;border:1px solid var(--line);border-radius:14px;padding:12px 14px;font-weight:700" />
                          <button id="issue">Issue & Send to Email</button>
                          <button id="wa">Share via WhatsApp</button>
                        </div>

                <div id="issueMsg" class="hint" style="margin-top:10px"></div>
              </div>

    <div class="row">
      <button id="copy">Copy Link</button>
      <button class="btn2" id="open">Open Passport</button>
    </div>

    <div class="hint" style="margin-top:12px">
      ✅ You can share this link worldwide.<br/>
      ⚠️ If registry does not contain this ID yet, the verify page may show NOT FOUND until issuance is recorded.
    </div>
  </div>

</div>

  <script src="../config.js"></script>
    <script>
  function pad6(n){ return String(n).padStart(6,"0"); }

  function generateId(){
    // simple + strong enough for MVP uniqueness:
    const now = Date.now() % 1000000;
    const rnd = Math.floor(Math.random()*1000000);
    const mix = (now + rnd) % 1000000;
    return "QRTP4-" + pad6(mix);
  }

  const genBtn = document.getElementById("gen");
  const out = document.getElementById("out");
  const pid = document.getElementById("pid");
  const plink = document.getElementById("plink");
  const copy = document.getElementById("copy");
  const open = document.getElementById("open");

  genBtn.onclick = async () => {
    const id = generateId();
    const url = location.origin + location.pathname.replace("/generate/", "/p/?id=") + encodeURIComponent(id);

    pid.textContent = id;
    plink.innerHTML = `<a href="${url}" target="_blank">${url}</a>`;
    out.style.display = "block";

      // Email & Issue logic
      const emailEl = document.getElementById('email');
      const issueBtn = document.getElementById('issue');
      const waBtn = document.getElementById('wa');
      const issueMsg = document.getElementById('issueMsg');

      const SUPABASE_URL = (window.QRTP4_CONFIG && window.QRTP4_CONFIG.SUPABASE_URL) || '';
      const SUPABASE_ANON_KEY = (window.QRTP4_CONFIG && window.QRTP4_CONFIG.SUPABASE_ANON_KEY) || '';
      const issueEndpoint = 'https://aaczdhxzzsvrvwbfgvst.supabase.co/functions/v1/issue_basic';

      issueBtn.onclick = async () => {
            const email = (emailEl.value || '').trim().toLowerCase();
            if (!email || !email.includes('@')) {
                    issueMsg.textContent = '⚠️ Please enter a valid email.';
                    return;
                  }
            if (!SUPABASE_ANON_KEY) {
                    issueMsg.textContent = '❌ CONFIG MISSING: SUPABASE_ANON_KEY not found in config.js';
                    return;
                  }

            issueBtn.textContent = 'Sending…';
            issueBtn.disabled = true;

            try {
                    const resp = await fetch(issueEndpoint, {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + SUPABASE_ANON_KEY, 'apikey': SUPABASE_ANON_KEY },
                              body: JSON.stringify({ email, id })
                                      });

                    const data = await resp.json().catch(() => ({}));

                    if (!resp.ok) {
                              issueMsg.textContent = '❌ Issuance failed: ' + (data.error || resp.statusText);
                            } else {
                              issueMsg.textContent = '✅ Issued & sent. Check your inbox. Verification link: ' + (data.verifyLink || url);
                            }
                  } catch (e) {
                    issueMsg.textContent = '❌ Network error. Please try again.';
                  } finally {
                    issueBtn.textContent = 'Issue & Send to Email';
                    issueBtn.disabled = false;
                  }
          };

      waBtn.onclick = () => {
            const msg = `QRTP-4 Passport ${id}\nVerify: ${url}\nQRTP-4 Global Standard`;
            const wa = 'https://wa.me/?text=' + encodeURIComponent(msg);
            window.open(wa, '_blank');
          };

    copy.onclick = async () => {
      try{
        await navigator.clipboard.writeText(url);
        copy.textContent = "Copied ✅";
      }catch(e){
        copy.textContent = "Copy failed ⚠️";
      }
    };

    open.onclick = () => window.open(url, "_blank");
  };
</script>

</body>
</html>
